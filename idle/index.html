<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>挂机冒险岛</title>
  <style>
    :root{--bg:#0b1220;--card:rgba(255,255,255,0.04);--muted:#9aa7c7;--accent:#4c7bf0}
    html,body{height:100%;margin:0;font-family:Inter, "Helvetica Neue", Arial;background:linear-gradient(180deg,var(--bg),#071028);color:#e6eef9}
    .wrap{max-width:1400px;margin:28px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(2,6,23,0.6);display:grid;grid-template-columns:280px 280px 1fr;gap:16px}
    .card{background:var(--card);padding:14px;border-radius:10px}
    h1{margin:0 0 8px;font-size:18px}
    .stat{display:flex;flex-wrap:wrap;gap:8px}
    .stat div{min-width:140px}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    select,button,input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#071223;color:inherit}
    button.primary{background:var(--accent);border:none;color:white;font-weight:700}
    button.danger{background:#c94b4b;border:none;color:white}
    .small{font-size:13px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .hpbar{height:12px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden;margin-top:6px}
    .hpbar > i{display:block;height:100%;background:linear-gradient(90deg,#ff6b6b,#ffb86b)}
    .row{display:flex;gap:8px;align-items:center}
    .center{display:flex;flex-direction:column;justify-content:center;align-items:center}
    .inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-top:8px}
    .item-slot{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;cursor:pointer;transition:all 0.2s;position:relative}
    .item-slot:hover{background:rgba(255,255,255,0.08);transform:translateY(-2px)}
    .item-slot.equipment{border:1px solid rgba(76,123,240,0.3)}
    .item-slot.consumable{border:1px solid rgba(76,240,123,0.3)}
    .item-name{font-weight:700;font-size:14px}
    .tooltip{position:absolute;background:rgba(10,15,30,0.98);border:1px solid rgba(76,123,240,0.5);padding:12px;border-radius:8px;font-size:13px;z-index:1000;pointer-events:none;opacity:0;transition:opacity 0.2s;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,0.5)}
    .item-slot:hover .tooltip,.equipment-slot:hover .tooltip{opacity:1}
    .tooltip-title{font-weight:700;margin-bottom:8px;color:#fff}
    .tooltip-stat{color:var(--muted);margin:4px 0}
    .tooltip-stat.positive{color:#4caf50}
    .equipment-slot{position:relative}
    @media(max-width:1200px){.wrap{grid-template-columns:1fr 1fr;}}
    @media(max-width:768px){.wrap{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 左侧面板：角色、控制 -->
    <div class="card">
      <h1>角色面板</h1>
      <div class="stat">
        <div>
          <div class="small">等级</div>
          <div id="plLevel" style="font-weight:700;font-size:20px">200</div>
        </div>
        <div>
          <div class="small">攻击力</div>
          <div id="plAtk" style="font-weight:700;font-size:20px">120</div>
        </div>
        <div>
          <div class="small">力量</div>
          <div id="plMain" style="font-weight:700;font-size:20px">50</div>
        </div>
        <div>
          <div class="small">敏捷</div>
          <div id="plSub" style="font-weight:700;font-size:20px">20</div>
        </div>
        <div style="width:100%">
          <div class="small">经验</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div id="plExp" style="font-weight:700">0</div>
            <div class="small">/ <span id="expToNext">1000</span></div>
          </div>
          <div class="hpbar"><i id="expBar" style="width:0%"></i></div>
        </div>
        <div style="width:100%">
          <div class="small">金币</div>
          <div id="plGold" style="font-weight:700">0</div>
        </div>
      </div>

      <label>控制</label>
      <div class="row">
        <button id="startBtn" class="primary">开始挂机</button>
        <button id="stopBtn" class="danger">停止挂机</button>
      </div>

      <div style="margin-top:12px">
        <button id="resetBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.04)">重置进度</button>
      </div>
    </div>

    <!-- 装备栏面板 -->
    <div class="card">
      <h1>装备栏</h1>
      <div class="small" style="margin-bottom:8px">点击装备可卸下到物品栏</div>
      
      <div class="card equipment-slot" id="weaponSlot" style="background:rgba(76,123,240,0.08);margin-top:8px;cursor:pointer" title="点击卸下">
        <div class="small" style="margin-bottom:4px">武器</div>
        <div id="weaponName" style="font-weight:700">长剑</div>
        <div class="tooltip" id="weaponTooltip" style="left:100%;top:0;margin-left:8px">
          <div class="tooltip-title">长剑</div>
          <div class="tooltip-stat positive">攻击力 +20</div>
        </div>
      </div>
      
      <div class="card equipment-slot" id="hatSlot" style="background:rgba(76,123,240,0.08);margin-top:8px;cursor:pointer" title="点击卸下">
        <div class="small" style="margin-bottom:4px">帽子</div>
        <div id="hatName" style="font-weight:700">新手帽子</div>
        <div class="tooltip" id="hatTooltip" style="left:100%;top:0;margin-left:8px">
          <div class="tooltip-title">新手帽子</div>
          <div class="tooltip-stat positive">力量 +5</div>
          <div class="tooltip-stat positive">敏捷 +5</div>
        </div>
      </div>
    </div>

    <!-- 物品栏面板 -->
    <div class="card">
      <h1>物品栏</h1>
      <div class="small" style="margin-bottom:8px">点击装备穿戴</div>
      <div id="inventoryGrid" class="inventory-grid">
        <!-- 物品将动态生成 -->
      </div>
    </div>

    <!-- 地图与怪物面板 -->
    <div class="card">
      <h1>地图与怪物</h1>

      <label>选择地图</label>
      <select id="mapSelect"></select>

      <label>选择怪物</label>
      <select id="monsterSelect"></select>

      <div style="margin-top:12px">
        <div class="small">当前怪物</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <div>
            <div id="monName" style="font-weight:700">无</div>
            <div class="small">Lv <span id="monLevel">0</span></div>
          </div>
          <div style="text-align:right">
            <div class="small">金币/击杀</div>
            <div id="monGold" style="font-weight:700">0</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="small">怪物 HP</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div id="monHPtxt" style="font-weight:700">0 / 0</div>
            <div class="small" id="killInfo">击杀: 0</div>
          </div>
          <div class="hpbar"><i id="monHPbar" style="width:100%"></i></div>
        </div>
      </div>
    </div>
  </div>

<script>
// MAPS 将从 map.json 异步加载
let MAPS = [];

/* =========================
   EXP 表（由你手动填写需要的每一级经验）
   例：EXP_TABLE[200] = 本级升级所需经验
   若 table 中没有对应等级，代码会把需要经验设置为非常大（无法升级）
   ========================= */
const EXP_TABLE = {
  // 示例：200~220（你可以自行扩展/改写）
  200: 1000,
  201: 1200,
  202: 1400,
  203: 1600,
  204: 1850,
  205: 2100,
  206: 2400,
  207: 2700,
  208: 3050,
  209: 3450,
  210: 3900,
  211: 4400,
  212: 4950,
  213: 5550,
  214: 6200,
  215: 6900,
  216: 7650,
  217: 8450,
  218: 9300,
  219: 10200,
  220: 11200
};

/* =========================
   存档 Key & 初始状态
   ========================= */
const SAVE_KEY = "idle_fight_equipment_v2";

let state = {
  level: 200,           // 玩家等级（初始200）
  baseAtk: 100,         // 基础攻击力
  mainStat: 50,         // 主属性
  subStat: 20,          // 副属性
  exp: 0,               // 当前经验
  expToLevel: EXP_TABLE[200] || 999999999, // 当前等级升级所需（从表读取）
  gold: 0,
  running: false,
  currentMapIndex: 0,
  currentMonsterIndex: 0,
  currentMonsterHP: 0,
  totalKillsSinceStart: 0,
  equipment: {},
  inventory: []
};

/* =========================
   DOM 元素
   ========================= */
const plLevelEl = document.getElementById("plLevel");
const plAtkEl = document.getElementById("plAtk");
const plMainEl = document.getElementById("plMain");
const plSubEl = document.getElementById("plSub");
const plExpEl = document.getElementById("plExp");
const expToNextEl = document.getElementById("expToNext");
const expBarEl = document.getElementById("expBar");
const plGoldEl = document.getElementById("plGold");

const weaponNameEl = document.getElementById("weaponName");
const weaponTooltipEl = document.getElementById("weaponTooltip");
const hatNameEl = document.getElementById("hatName");
const hatTooltipEl = document.getElementById("hatTooltip");

const mapSelectEl = document.getElementById("mapSelect");
const monsterSelectEl = document.getElementById("monsterSelect");

const monNameEl = document.getElementById("monName");
const monLevelEl = document.getElementById("monLevel");
const monHPtxtEl = document.getElementById("monHPtxt");
const monHPbarEl = document.getElementById("monHPbar");
const monGoldEl = document.getElementById("monGold");
const killInfoEl = document.getElementById("killInfo");

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const resetBtn = document.getElementById("resetBtn");

const inventoryGridEl = document.getElementById("inventoryGrid");

/* =========================
   存档 / 加载
   ========================= */
function save() {
  // 保存时排除running状态
  const { running, ...saveState } = state;
  localStorage.setItem(SAVE_KEY, JSON.stringify(saveState));
}

async function loadInitialState() {
  try {
    const response = await fetch('./init_state.json');
    if (!response.ok) throw new Error('Failed to load init_state.json');
    return await response.json();
  } catch (error) {
    console.error('加载初始状态失败:', error);
    // 降级方案：返回硬编码的初始状态
    return {
      level: 200,
      baseAtk: 100,
      mainStat: 50,
      subStat: 20,
      exp: 0,
      gold: 0,
      currentMapIndex: 0,
      currentMonsterIndex: 0,
      currentMonsterHP: 0,
      totalKillsSinceStart: 0,
      equipment: {},
      inventory: [
        { id: "long_sword", name: "长剑", type: "equipment", slot: "weapon", atk: 20 },
        { id: "beginner_hat", name: "新手帽子", type: "equipment", slot: "hat", mainStat: 5, subStat: 5 },
        { id: "iron_sword", name: "铁剑", type: "equipment", slot: "weapon", atk: 35 },
        { id: "leather_cap", name: "皮帽", type: "equipment", slot: "hat", mainStat: 8, subStat: 8 }
      ]
    };
  }
}

async function load() {
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) {
    // 没有存档，加载初始状态
    console.log('没有找到存档，加载初始状态...');
    const initialState = await loadInitialState();
    console.log('初始状态已加载:', initialState);
    Object.assign(state, initialState);
    state.expToLevel = EXP_TABLE[state.level] || 999999999;
    state.running = false; // 确保running为false
    console.log('state已更新:', state);
    return;
  }
  try {
    const s = JSON.parse(raw);
    console.log('加载存档:', s);
    Object.assign(state, s);
    state.expToLevel = EXP_TABLE[state.level] || 999999999;
    state.running = false; // 加载存档后强制设置running为false
    if (typeof state.level !== "number") state.level = 200;
    // 确保装备数据存在
    if (!state.equipment) {
      state.equipment = {};
    }
    // 兼容旧存档：如果有atk但没有baseAtk，转换为baseAtk
    if (state.atk && !state.baseAtk) {
      state.baseAtk = state.atk - (state.equipment.weapon?.atk || 0);
      delete state.atk;
    }
    // 确保inventory存在
    if (!state.inventory || state.inventory.length === 0) {
      console.log('inventory为空，加载初始inventory...');
      const initialState = await loadInitialState();
      state.inventory = initialState.inventory;
    }
  } catch(e){
    console.error("加载存档失败", e);
  }
}

/* =========================
   小工具
   ========================= */
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
function format(n){
  if (n < 1000) return String(Math.floor(n));
  const units = ["K","M","B","T"];
  let u = -1;
  while (n >= 1000 && u < units.length-1){ n /= 1000; u++; }
  return n.toFixed(2) + units[u];
}

/* =========================
   构建地图下拉（只显示符合等级的地图）
   ========================= */
function buildMapOptions() {
  mapSelectEl.innerHTML = "";
  MAPS.forEach((m, idx) => {
    if (state.level >= m.requiredLevel) {
      const opt = document.createElement("option");
      opt.value = idx;
      opt.textContent = `${m.name}（要求 Lv ${m.requiredLevel}）`;
      mapSelectEl.appendChild(opt);
    }
  });
  // 选择有效索引
  if (!mapSelectEl.querySelector(`option[value="${state.currentMapIndex}"]`)) {
    if (mapSelectEl.options.length > 0) {
      state.currentMapIndex = parseInt(mapSelectEl.options[0].value, 10);
    } else {
      state.currentMapIndex = 0;
    }
  }
  mapSelectEl.value = state.currentMapIndex;
  buildMonsterOptions();
}

/* =========================
   构建怪物下拉（基于当前地图）
   ========================= */
function buildMonsterOptions() {
  monsterSelectEl.innerHTML = "";
  const map = MAPS[state.currentMapIndex];
  if (!map) return;
  map.monsters.forEach((mon, idx) => {
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = `${mon.name} (Lv ${mon.level}) HP:${mon.hp}`;
    monsterSelectEl.appendChild(opt);
  });
  if (!monsterSelectEl.querySelector(`option[value="${state.currentMonsterIndex}"]`)) {
    state.currentMonsterIndex = 0;
  }
  monsterSelectEl.value = state.currentMonsterIndex;
  if (!state.currentMonsterHP || state.currentMonsterHP <= 0) resetCurrentMonsterHP();
  updateUI();
}

/* =========================
   重置当前怪物为满血
   ========================= */
function resetCurrentMonsterHP() {
  const mon = getCurrentMonsterDef();
  if (!mon) { state.currentMonsterHP = 0; return; }
  state.currentMonsterHP = mon.hp;
}

/* =========================
   获取当前怪物定义
   ========================= */
function getCurrentMonsterDef() {
  const map = MAPS[state.currentMapIndex];
  if (!map) return null;
  return map.monsters[state.currentMonsterIndex];
}

/* =========================
   使用装备（从物品栏穿戴）
   ========================= */
function equipItem(itemIndex) {
  const item = state.inventory[itemIndex];
  if (!item) return;
  
  // 只有装备类型可以穿戴
  if (!item.slot) {
    alert('该物品无法装备');
    return;
  }
  
  const slot = item.slot;
  
  // 如果该位置已有装备，卸下到物品栏
  if (state.equipment[slot]) {
    state.inventory.push(state.equipment[slot]);
  }
  
  // 穿上新装备
  state.equipment[slot] = { ...item };
  
  // 从物品栏移除
  state.inventory.splice(itemIndex, 1);
  
  updateUI();
  save();
}

/* =========================
   卸下装备到物品栏
   ========================= */
function unequipItem(slot) {
  if (!state.equipment[slot]) return;
  
  // 放入物品栏
  state.inventory.push(state.equipment[slot]);
  
  // 删除装备，槽位变为空
  delete state.equipment[slot];
  
  updateUI();
  save();
}

/* =========================
   渲染物品栏
   ========================= */
function renderInventory() {
  inventoryGridEl.innerHTML = '';
  
  if (state.inventory.length === 0) {
    inventoryGridEl.innerHTML = '<div class="small" style="grid-column:1/-1;text-align:center;padding:20px">物品栏为空</div>';
    return;
  }
  
  state.inventory.forEach((item, index) => {
    const div = document.createElement('div');
    div.className = `item-slot ${item.type || 'equipment'}`;
    
    // 构建悬浮提示内容
    let tooltipHtml = `<div class="tooltip-title">${item.name}</div>`;
    if (item.atk) tooltipHtml += `<div class="tooltip-stat positive">攻击力 +${item.atk}</div>`;
    if (item.mainStat) tooltipHtml += `<div class="tooltip-stat positive">力量 +${item.mainStat}</div>`;
    if (item.subStat) tooltipHtml += `<div class="tooltip-stat positive">敏捷 +${item.subStat}</div>`;
    
    div.innerHTML = `
      <div class="item-name">${item.name}</div>
      <div class="tooltip" style="bottom:100%;left:50%;transform:translateX(-50%);margin-bottom:8px">${tooltipHtml}</div>
    `;
    
    div.addEventListener('click', () => equipItem(index));
    inventoryGridEl.appendChild(div);
  });
}

/* =========================
   获取总攻击力（基础 + 装备）
   ========================= */
function getTotalAtk() {
  let total = state.baseAtk || 0;
  if (state.equipment?.weapon) {
    total += state.equipment.weapon.atk || 0;
  }
  return total;
}

/* =========================
   获取总主属性（基础 + 装备）
   ========================= */
function getTotalMainStat() {
  let total = state.mainStat || 0;
  if (state.equipment?.hat) {
    total += state.equipment.hat.mainStat || 0;
  }
  return total;
}

/* =========================
   获取总副属性（基础 + 装备）
   ========================= */
function getTotalSubStat() {
  let total = state.subStat || 0;
  if (state.equipment?.hat) {
    total += state.equipment.hat.subStat || 0;
  }
  return total;
}

/* =========================
   伤害计算（返回整数伤害）
   damage = atk * (main*4 + sub) / 100 * 1.3
   ========================= */
function calcDamage() {
  const totalAtk = getTotalAtk();
  const totalMain = getTotalMainStat();
  const totalSub = getTotalSubStat();
  const dmg = totalAtk * ((totalMain * 4 + totalSub) / 100) * 1.3;
  return Math.floor(dmg);
}

/* =========================
   等级差系数（经验系数）
   - diff <= 2 -> 1.2
   - diff <= 5 -> 1.1
   - diff <= 20 -> 1.0
   - else -> 0
   ========================= */
function getLevelExpFactor(playerLevel, monsterLevel) {
  const diff = Math.abs(playerLevel - monsterLevel);
  if (diff <= 2) return 1.2;
  if (diff <= 5) return 1.1;
  if (diff <= 20) return 1.0;
  return 0.0;
}

/* =========================
   尝试升级（使用 EXP_TABLE）
   升级时：主属性 +5 / 级
   支持多级同时升级（exp 可溢出）
   ========================= */
function tryLevelUp() {
  let leveled = 0;
  // 确保 expToLevel 与表同步
  state.expToLevel = EXP_TABLE[state.level] || 999999999;
  while (state.exp >= state.expToLevel) {
    state.exp -= state.expToLevel;
    state.level += 1;
    state.mainStat += 5;
    leveled++;
    state.expToLevel = EXP_TABLE[state.level] || 999999999;
  }
  if (leveled > 0) {
    // 可能解锁地图，重新构建地图选项（保持当前 map 索引若仍可用）
    buildMapOptions();
  }
  return leveled;
}

/* =========================
   一次攻击的高效处理（O(1)）
   处理说明：
   - 先计算本次总伤害 dmg
   - 若 dmg < 当前怪物剩余HP，则直接扣血
   - 否则：计算可以击杀的总数 totalKills（包含当前正在打的怪）
     totalKills = 1 + floor((dmg - currHP) / fullHP)
     remainder = (dmg - currHP) % fullHP
   - 一次性发放金币与经验（经验按当前玩家等级的系数计算）
   - 将下一只怪物剩余血量设置为 fullHP - remainder（remainder==0 则满血）
   注意：为了性能，经验系数按攻击开始时玩家等级计算（不会基于击杀过程中可能产生的升级动态改变系数）。
   ========================= */
function attackTick() {
  if (!state.running) return;
  const mon = getCurrentMonsterDef();
  if (!mon) return;

  let dmg = calcDamage();
  if (dmg <= 0) return;

  let currHP = state.currentMonsterHP;
  const fullHP = mon.hp;

  // 快速路径：不足以击杀当前怪，只扣血
  if (dmg < currHP) {
    state.currentMonsterHP = currHP - dmg;
    updateUI();
    return;
  }

  // 可以至少击杀当前怪
  const afterKillCurr = dmg - currHP; // >= 0
  const extraKills = Math.floor(afterKillCurr / fullHP); // 可能为 0
  const remainder = afterKillCurr % fullHP; // 对下只怪物造成的伤害量（小于 fullHP）
  const totalKills = 1 + extraKills;

  // 发放奖励（一次性计算）
  // 金币总和（无等级差限制）
  const totalGold = totalKills * mon.gold;
  state.gold += totalGold;

  // 经验按等级差系数（使用攻击开始时玩家等级）
  const factor = getLevelExpFactor(state.level, mon.level);
  if (factor > 0) {
    const totalExp = totalKills * mon.exp * factor;
    // 使用浮点累加经验（tryLevelUp 会处理整数阈值）
    state.exp += totalExp;
  }

  // 更新累计击杀计数
  state.totalKillsSinceStart = (state.totalKillsSinceStart || 0) + totalKills;

  // 设置下一只怪物HP
  if (remainder === 0) {
    state.currentMonsterHP = fullHP;
  } else {
    state.currentMonsterHP = fullHP - remainder;
  }

  // 升级检测（可能多级）
  tryLevelUp();

  updateUI();
}

/* =========================
   UI 更新
   ========================= */
function updateUI() {
  plLevelEl.textContent = state.level;
  plAtkEl.textContent = format(getTotalAtk());
  plMainEl.textContent = format(getTotalMainStat());
  plSubEl.textContent = format(getTotalSubStat());
  plExpEl.textContent = Math.floor(state.exp);
  expToNextEl.textContent = format(state.expToLevel);
  plGoldEl.textContent = format(state.gold);

  // 更新装备显示
  if (state.equipment?.weapon) {
    weaponNameEl.textContent = state.equipment.weapon.name;
    let weaponTooltip = `<div class="tooltip-title">${state.equipment.weapon.name}</div>`;
    if (state.equipment.weapon.atk) {
      weaponTooltip += `<div class="tooltip-stat positive">攻击力 +${state.equipment.weapon.atk}</div>`;
    }
    weaponTooltipEl.innerHTML = weaponTooltip;
  } else {
    weaponNameEl.textContent = '（空）';
    weaponTooltipEl.innerHTML = '<div class="tooltip-title">无装备</div><div class="tooltip-stat">点击物品栏中的武器穿戴</div>';
  }
  if (state.equipment?.hat) {
    hatNameEl.textContent = state.equipment.hat.name;
    let hatTooltip = `<div class="tooltip-title">${state.equipment.hat.name}</div>`;
    if (state.equipment.hat.mainStat) {
      hatTooltip += `<div class="tooltip-stat positive">力量 +${state.equipment.hat.mainStat}</div>`;
    }
    if (state.equipment.hat.subStat) {
      hatTooltip += `<div class="tooltip-stat positive">敏捷 +${state.equipment.hat.subStat}</div>`;
    }
    hatTooltipEl.innerHTML = hatTooltip;
  } else {
    hatNameEl.textContent = '（空）';
    hatTooltipEl.innerHTML = '<div class="tooltip-title">无装备</div><div class="tooltip-stat">点击物品栏中的帽子穿戴</div>';
  }

  // exp 进度条
  const ratio = clamp(state.exp / (state.expToLevel || 1), 0, 1);
  expBarEl.style.width = (ratio * 100) + "%";

  const mon = getCurrentMonsterDef();
  if (mon) {
    monNameEl.textContent = mon.name;
    monLevelEl.textContent = mon.level;
    monGoldEl.textContent = format(mon.gold);
    monHPtxtEl.textContent = `${format(state.currentMonsterHP)} / ${format(mon.hp)}`;
    const hpRatio = clamp(state.currentMonsterHP / mon.hp, 0, 1);
    monHPbarEl.style.width = (hpRatio * 100) + "%";
  } else {
    monNameEl.textContent = "无";
    monLevelEl.textContent = "";
    monHPtxtEl.textContent = `0 / 0`;
    monHPbarEl.style.width = "0%";
    monGoldEl.textContent = "0";
  }

  killInfoEl.textContent = `累计击杀: ${format(state.totalKillsSinceStart || 0)}`;
  
  // 渲染物品栏
  renderInventory();
}

/* =========================
   事件绑定
   ========================= */
mapSelectEl.addEventListener("change", () => {
  state.currentMapIndex = parseInt(mapSelectEl.value, 10);
  state.currentMonsterIndex = 0;
  resetCurrentMonsterHP();
  buildMonsterOptions();
  save();
});

monsterSelectEl.addEventListener("change", () => {
  state.currentMonsterIndex = parseInt(monsterSelectEl.value, 10);
  resetCurrentMonsterHP();
  updateUI();
  save();
});

startBtn.addEventListener("click", () => {
  state.running = true;
  save();
});
stopBtn.addEventListener("click", () => {
  state.running = false;
  save();
});
resetBtn.addEventListener("click", () => {
  if (!confirm("确定重置所有进度吗？")) return;
  // 先停止挂机，避免自动保存覆盖删除的存档
  state.running = false;
  // 延迟删除存档和刷新，确保停止状态已设置
  setTimeout(() => {
    localStorage.removeItem(SAVE_KEY);
    location.reload();
  }, 100);
});

document.getElementById("weaponSlot").addEventListener("click", () => {
  if (state.equipment.weapon) {
    unequipItem('weapon');
  }
});

document.getElementById("hatSlot").addEventListener("click", () => {
  if (state.equipment.hat) {
    unequipItem('hat');
  }
});

/* =========================
   初始化
   ========================= */
async function init() {
  // 加载地图数据
  try {
    const response = await fetch('./map.json');
    if (!response.ok) throw new Error('Failed to load map.json');
    MAPS = await response.json();
  } catch (error) {
    console.error('加载地图数据失败:', error);
    alert('加载地图数据失败，请检查 map.json 文件是否存在');
    return;
  }

  await load();
  // 初始化 expToLevel（如果缺失）
  state.expToLevel = EXP_TABLE[state.level] || 999999999;
  // 构建地图（只显示可入场的）
  buildMapOptions();
  // 如果 currentMonsterHP 无效，设置为选中怪满血
  if (!state.currentMonsterHP || state.currentMonsterHP <= 0) resetCurrentMonsterHP();
  updateUI();
}

// 每秒攻击一次
setInterval(attackTick, 1000);
// 自动保存
setInterval(save, 5000);
// 保存离开
window.addEventListener("beforeunload", save);

// 启动
init();
</script>
</body>
</html>
