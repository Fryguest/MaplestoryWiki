<!DOCTYPE html>
<html lang="zh">

<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>每周搬蛋计算器</title>
    <style>
        /* 小幅样式补充，遵循 starforce_simulator 风格 */
        .content {
            max-width: 1400px;
            margin: 24px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .controls label {
            font-weight: 600;
            color: #555;
        }

        .controls select {
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .controls button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .controls button:hover {
            background: #45a049;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }

        th {
            background: #4CAF50;
            color: white;
            font-weight: 600;
        }

        tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        tbody tr:hover {
            background: #f0f0f0;
        }

        .right {
            text-align: right;
        }

        .summary {
            margin-top: 12px;
            font-weight: 600;
        }

        .muted {
            color: #666;
            font-size: 0.9em;
            margin-top: 8px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }

        .counted {
            background: #e8ffe8 !important;
        }

        .boss-options {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 8px 16px;
            align-items: center;
        }

        .boss-options label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .boss-options label:hover {
            background: #e8f5e9;
        }

        .boss-options input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .boss-name {
            font-weight: 600;
            color: #333;
        }

        .no-fight-option {
            color: #999;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div id="sidebar-container"></div>

    <div class="content">
        <h2>每周搬蛋计算器</h2>

        <div class="controls">
            <label for="serverSelect">服务器:</label>
            <select id="serverSelect">
                <option value="gms">GMS</option>
                <!-- <option value="tms">TMS</option> -->
            </select>
        </div>

        <div id="note" class="muted">说明：选择你攻略的所有BOSS, 会自动计算价格最高的14个结晶</div>

        <div id="bossContainer"></div>

        <div id="result" class="summary"></div>
    </div>

    <script>
        const serverSelect = document.getElementById('serverSelect');
        // const loadBtn = document.getElementById('loadBtn');
        const bossContainer = document.getElementById('bossContainer');
        const resultDiv = document.getElementById('result');

        // JSON 文件路径（基于仓库结构）
        const serverToPath = {
            gms: 'data/boss_meso/gms.json',
            tms: 'data/boss_meso/tms.json'
        };

        // loadBtn.addEventListener('click', () => {
        //     loadBosses(serverSelect.value);
        // });

        // 初始加载默认服务器
        loadBosses(serverSelect.value);

        async function loadBosses(serverKey) {
            bossContainer.innerHTML = '载入中...';
            resultDiv.innerText = '';
            const path = serverToPath[serverKey];
            try {
                const res = await fetch(path);
                if (!res.ok) throw new Error('加载失败: ' + res.status);
                const json = await res.json();
                const weekly = json['Weekly'] || {};
                renderBossTable(weekly);
            } catch (err) {
                bossContainer.innerHTML = `<div class="muted">无法加载 ${serverKey} 数据: ${err.message}</div>`;
            }
        }

        function renderBossTable(weeklyObj) {
            const bossNames = Object.keys(weeklyObj);
            
            // 按每个boss的最低难度meso数量从少到多排序
            bossNames.sort((a, b) => {
                const diffsA = Object.values(weeklyObj[a]);
                const diffsB = Object.values(weeklyObj[b]);
                const minA = Math.min(...diffsA);
                const minB = Math.min(...diffsB);
                return minA - minB;
            });
            
            if (bossNames.length === 0) {
                bossContainer.innerHTML = '<div class="muted">未找到 Weekly boss 列表。</div>';
                return;
            }

            let html = `<table>
                <thead><tr><th>Boss</th><th>难度选择 (每周 meso)</th></tr></thead><tbody>`;

            for (const name of bossNames) {
                const diffs = weeklyObj[name];
                const groupName = `boss_${name.replace(/\s+/g, '_')}`;
                
                let options = `<label class="no-fight-option">
                    <input type="radio" name="${groupName}" value="" data-boss="${escapeHtml(name)}" class="boss-radio" checked>
                    不打
                </label>`;
                
                // 按meso数量从少到多排序
                const diffKeys = Object.keys(diffs);
                diffKeys.sort((a, b) => (diffs[a] - diffs[b]));
                for (const d of diffKeys) {
                    const v = diffs[d];
                    options += `<label>
                        <input type="radio" name="${groupName}" value="${encodeURIComponent(d)}|${v}" data-boss="${escapeHtml(name)}" class="boss-radio">
                        ${escapeHtml(d)} — ${formatNumber(v)}
                    </label>`;
                }
                
                html += `<tr>
                    <td class="boss-name">${escapeHtml(name)}</td>
                    <td>
                        <div class="boss-options">
                            ${options}
                        </div>
                    </td>
                </tr>`;
            }

            html += `</tbody></table>`;
            bossContainer.innerHTML = html;

            document.querySelectorAll('.boss-radio').forEach(radio => {
                radio.addEventListener('change', () => {
                    calculateWeeklyMeso();
                });
            });
        }

        function calculateWeeklyMeso() {
            const rows = [];
            document.querySelectorAll('.boss-radio:checked').forEach(radio => {
                const boss = radio.dataset.boss;
                const val = radio.value;
                if (!val) return; // 跳过"不打这个boss"选项
                
                const [encDiff, vStr] = val.split('|');
                const diff = decodeURIComponent(encDiff);
                const value = Number(vStr) || 0;
                rows.push({ boss, diff, value });
            });

            if (rows.length === 0) {
                resultDiv.innerText = '未选择任何 boss 或难度。';
                return; 
            }

            rows.sort((a, b) => b.value - a.value);
            const counted = rows.slice(0, 14);
            const sum = counted.reduce((s, r) => s + r.value, 0);

            let out = `<div>已选择 boss: ${rows.length} 个；计入最高 14 个 boss。</div>`;
            out += `<table><thead><tr><th>计入</th><th>Boss</th><th>难度</th><th class="right">每周 meso</th></tr></thead><tbody>`;
            for (let i = 0; i < rows.length; i++) {
                const r = rows[i];
                const isCounted = i < 14;
                out += `<tr ${isCounted ? 'class="counted"' : ''}>
                    <td class="right">${isCounted ? '✓' : ''}</td>
                    <td>${escapeHtml(r.boss)}</td>
                    <td>${escapeHtml(r.diff)}</td>
                    <td class="right">${formatNumber(r.value)}</td>
                </tr>`;
            }
            out += `</tbody></table>`;
            out += `<div style="margin-top:8px;font-size:1.1em">每周总 meso（前 14 个）： ${formatNumber(sum)}</div>`;

            resultDiv.innerHTML = out;
        }

        function formatNumber(n) {
            return Number(n).toLocaleString('en-US');
        }

        function escapeHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
    </script>

    <script>
        // 加载侧边栏（与 starforce_simulator.html 保持一致）
        fetch('sidebar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('sidebar-container').innerHTML = data;
            })
            .catch(error => {
                console.error('加载侧边栏失败:', error);
            });

        // 控制子菜单展开/收起（更健壮的实现）
        function toggleSubMenu(id) {
            const submenu = document.getElementById(id);
            if (!submenu) return;
            submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
        }
    </script>
</body>

</html>