<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="./static/css/bootstrap.min.css">
  <link rel="icon" href="/MaplestoryWiki/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/MaplestoryWiki/favicon.ico" type="image/x-icon">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>上星模拟器</title>
  <style>
    /* 预留侧栏宽度后在剩余区域居中（通用） */
    .remain-center {
      padding-left: 240px;
    }

    .remain-center .inner {
      margin: 0 auto;
      width: min(1100px, calc(100vw - 240px));
      min-width: 320px;
      padding: 0 12px;
    }
  </style>
</head>

<body>
  <!-- JavaScript 动态加载左侧目录 -->
  <div id="sidebar-container"></div>

  <div class="container my-4">
    <div class="remain-center">
      <div class="inner">
        <h1 class="mb-4">上星模拟器</h1>
        <div class="row g-4">
          <div class="col-12">
            <div class="card shadow-sm mb-4">
              <div class="card-header fw-bold" role="button" data-bs-toggle="collapse" data-bs-target="#simCollapse"
                aria-expanded="true" aria-controls="simCollapse">上星模拟器</div>
              <div id="simCollapse" class="collapse show">
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-12">
                      <div class="fw-bold mb-2">服务器选择</div>
                      <div class="row g-3 align-items-end">
                        <div class="col-12">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="serverRadio" id="serverTMS" value="tms" checked>
                            <label class="form-check-label" for="serverTMS">
                              TMS (台服)
                            </label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="serverRadio" id="serverGMS" value="gms">
                            <label class="form-check-label" for="serverGMS">
                              GMS (国际服)
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-12">
                      <hr class="my-2">
                      <div class="fw-bold mb-2">活动优惠</div>
                      <div class="row g-3">
                        <div class="col-12">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="discountCheckbox">
                            <label class="form-check-label" for="discountCheckbox">
                              上星7折（费用变为70%）
                            </label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="guaranteedCheckbox">
                            <label class="form-check-label" for="guaranteedCheckbox">
                              5, 10, 15星必成（5→6, 10→11, 15→16星成功率100%）
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-12">
                      <hr class="my-2">
                      <div class="fw-bold mb-2">起始状态</div>
                      <div class="row g-3 align-items-end">
                        <div class="col-12 col-md-4">
                          <label for="startMesos" class="form-label">金币数量（留空=无限）</label>
                          <input type="number" id="startMesos" class="form-control" placeholder="" min="0">
                        </div>
                        <div class="col-6 col-md-4">
                          <label for="equipLevel" class="form-label">装备等级</label>
                          <select id="equipLevel" class="form-select">
                            <option value="130">130</option>
                            <option value="140">140</option>
                            <option value="150">150</option>
                            <option value="160">160</option>
                            <option value="200">200</option>
                            <option value="250">250</option>
                          </select>
                        </div>
                        <div class="col-6 col-md-4">
                          <label for="startStar" class="form-label">装备强化阶段</label>
                          <input type="number" id="startStar" class="form-control" value="0" min="0" max="29">
                        </div>
                      </div>
                    </div>

                    <div class="col-12">
                      <hr class="my-2">
                      <div class="fw-bold mb-2">当前状态</div>
                      <div class="row g-3">
                        <div class="col-12 col-md-4">
                          <div class="form-text mb-1">金币数量</div>
                          <div id="currentMesosText" class="fs-6">∞</div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="form-text mb-1">装备等级</div>
                          <div id="currentLevelText" class="fs-6">-</div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="form-text mb-1">强化阶段</div>
                          <div id="currentStarText" class="fs-6">0★</div>
                        </div>
                      </div>
                    </div>

                    <div class="col-12 d-flex gap-2 flex-wrap mt-2">
                      <button id="simulateOnceBtn" class="btn btn-primary">强化</button>
                      <button id="resetBtn" class="btn btn-outline-danger">重置</button>
                    </div>

                    <div class="col-12">
                      <div id="simulateResult" class="small text-muted"></div>
                    </div>

                    <div class="col-12">
                      <div class="mt-2">
                        <span class="me-3">累计消耗：<strong id="statsConsumedText">0</strong></span>
                        <span class="me-3">继承次数：<strong id="statsInheritText">0</strong></span>
                        <span>最高强化阶段：<strong id="statsHighestText">0★</strong></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-header fw-bold" role="button" data-bs-toggle="collapse" data-bs-target="#chanceCollapse"
            aria-expanded="false" aria-controls="chanceCollapse">上星概率表</div>
          <div id="chanceCollapse" class="collapse">
            <div class="card-body">
              <div class="table-responsive">
                <table id="enhanceChanceTable" class="table table-sm table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>强化阶段</th>
                      <th>成功几率</th>
                      <th>破坏几率</th>
                      <th>维持几率</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mb-4">
          <div class="card-header fw-bold" role="button" data-bs-toggle="collapse" data-bs-target="#costCollapse"
            aria-expanded="false" aria-controls="costCollapse">上星花费表</div>
          <div id="costCollapse" class="collapse">
            <div class="card-body">
              <div class="table-responsive">
                <table id="enhanceCostTable" class="table table-sm table-striped table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>强化阶段</th>
                      <th>130</th>
                      <th>140</th>
                      <th>150</th>
                      <th>160</th>
                      <th>200</th>
                      <th>250</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 加载侧边栏
    fetch('sidebar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('sidebar-container').innerHTML = data;
      })
      .catch(error => {
        console.error('加载侧边栏失败:', error);
      });

    function toggleSubMenu(id) {
      const submenu = document.getElementById(id);
      submenu.style.display = submenu.style.display === "block" ? "none" : "block";
    }

    // 全局变量存储当前服务器数据
    let currentServerData = {
      enhanceChanceData: [],
      enhanceCostData: []
    };
    let originalServerData = {
      enhanceChanceData: [],
      enhanceCostData: []
    };
    let currentServer = 'tms';
    let options = {
      discount: false,
      guaranteed: false
    };

    // 从JSON文件加载服务器数据
    async function loadServerData(server) {
      try {
        const response = await fetch(`./data/startforce/${server}.json`);
        const data = await response.json();
        // 深拷贝存储原始数据
        originalServerData = {
          enhanceChanceData: JSON.parse(JSON.stringify(data.enhanceChanceData)),
          enhanceCostData: JSON.parse(JSON.stringify(data.enhanceCostData))
        };
        currentServerData = data;
        currentServer = server;
        return data;
      } catch (error) {
        console.error(`加载${server}数据失败:`, error);
        return null;
      }
    }

    // 应用选项到数据
    function applyOptionsToData() {
      // 深拷贝原始数据
      currentServerData = {
        enhanceChanceData: JSON.parse(JSON.stringify(originalServerData.enhanceChanceData)),
        enhanceCostData: JSON.parse(JSON.stringify(originalServerData.enhanceCostData))
      };

      // 应用7折优惠
      if (options.discount) {
        currentServerData.enhanceCostData = currentServerData.enhanceCostData.map(row => {
          const newRow = { ...row };
          ['130', '140', '150', '160', '200', '250'].forEach(level => {
            if (newRow[level] != null) {
              newRow[level] = Math.floor(newRow[level] * 0.7);
            }
          });
          return newRow;
        });
      }

      // 应用5, 10, 15星必成
      if (options.guaranteed) {
        const guaranteedStages = ['5>6', '10>11', '15>16'];
        currentServerData.enhanceChanceData = currentServerData.enhanceChanceData.map(row => {
          if (guaranteedStages.includes(row.stage)) {
            return {
              ...row,
              success: 100,
              destroy: 0,
              keep: 0
            };
          }
          return row;
        });
      }
    }

    // 渲染概率表
    function renderChanceTable() {
      const tbody = document.querySelector("#enhanceChanceTable tbody");
      tbody.innerHTML = '';
      currentServerData.enhanceChanceData.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.stage}</td>
          <td>${row.success.toFixed(2)}%</td>
          <td>${row.destroy.toFixed(2)}%</td>
          <td>${row.keep.toFixed(2)}%</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 渲染消费表
    function renderCostTable() {
      const tbody2 = document.querySelector("#enhanceCostTable tbody");
      const formatNumber = function (n) { return n == null ? '-' : Number(n).toLocaleString(); };
      tbody2.innerHTML = '';
      currentServerData.enhanceCostData.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.stage}</td>
          <td>${formatNumber(row["130"])}</td>
          <td>${formatNumber(row["140"])}</td>
          <td>${formatNumber(row["150"])}</td>
          <td>${formatNumber(row["160"])}</td>
          <td>${formatNumber(row["200"])}</td>
          <td>${formatNumber(row["250"])}</td>
        `;
        tbody2.appendChild(tr);
      });
    }

    // 单次模拟：基于当前星级，按成功/破坏/维持概率，计算下一步结果与花费
    ; (async function initSimulator() {
      var els = {
        serverRadios: document.getElementsByName('serverRadio'),
        startMesos: document.getElementById('startMesos'),
        equipLevel: document.getElementById('equipLevel'),
        startStar: document.getElementById('startStar'),
        currentMesosText: document.getElementById('currentMesosText'),
        currentLevelText: document.getElementById('currentLevelText'),
        currentStarText: document.getElementById('currentStarText'),
        btnStrengthen: document.getElementById('simulateOnceBtn'),
        btnReset: document.getElementById('resetBtn'),
        resultBox: document.getElementById('simulateResult'),
        statsConsumedText: document.getElementById('statsConsumedText'),
        statsInheritText: document.getElementById('statsInheritText'),
        statsHighestText: document.getElementById('statsHighestText')
      };

      if (!els.btnStrengthen) return;

      var state = {
        infiniteMesos: true,
        startMesos: null,
        startLevel: Number(els.equipLevel.value),
        startStar: Number(els.startStar.value),
        currentMesos: Infinity,
        currentLevel: Number(els.equipLevel.value),
        currentStar: Number(els.startStar.value),
        highestStar: Number(els.startStar.value),
        totalConsumed: 0,
        inheritCount: 0,
        awaitingInherit: false
      };

      var formatNumber = function (n) { return n == null ? '-' : Number(n).toLocaleString(); };

      var syncFromInputsToStart = function () {
        var startMesosVal = els.startMesos.value;
        state.infiniteMesos = startMesosVal === '';
        state.startMesos = state.infiniteMesos ? null : Math.max(0, Number(startMesosVal));
        state.startLevel = Number(els.equipLevel.value);
        state.startStar = Math.min(29, Math.max(0, Number(els.startStar.value)));
        state.highestStar = Math.max(state.highestStar, state.startStar); // 更新最高强化阶段
      };

      var resetToStart = function () {
        syncFromInputsToStart();
        state.currentLevel = state.startLevel;
        state.currentStar = state.startStar;
        state.highestStar = state.startStar;
        state.currentMesos = state.infiniteMesos ? Infinity : Number(state.startMesos || 0);
        state.totalConsumed = 0;
        state.inheritCount = 0;
        state.awaitingInherit = false;
        setStrengthenLabel('强化');
        render();
        els.resultBox.textContent = '';
      };

      var formatMesos = function (n) { return n === Infinity ? '∞' : formatNumber(n); };

      var render = function () {
        els.currentMesosText.textContent = formatMesos(state.currentMesos);
        els.currentLevelText.textContent = String(state.currentLevel);
        els.currentStarText.textContent = state.currentStar + '★';
        els.statsConsumedText.textContent = formatNumber(state.totalConsumed);
        els.statsInheritText.textContent = String(state.inheritCount);
        var highest = state.highestStar;
        els.statsHighestText && (els.statsHighestText.textContent = highest + '★');
      };

      var setStrengthenLabel = function (text) {
        els.btnStrengthen.textContent = text;
      };
      var getCostByLevelAndStage = function (equipLevel, fromStar) {
        var row = currentServerData.enhanceCostData.find(function (r) { return r.stage === (fromStar + '>' + (fromStar + 1)); });
        if (!row) return null;
        return row[String(equipLevel)] == null ? null : Number(row[String(equipLevel)]);
      };

      var getChanceRow = function (fromStar) {
        return currentServerData.enhanceChanceData.find(function (r) { return r.stage === (fromStar + '>' + (fromStar + 1)); });
      };

      var pickOutcome = function (chanceRow) {
        var roll = Math.random() * 100;
        var s = chanceRow.success;
        var d = chanceRow.destroy;
        if (roll < s) return 'success';
        if (roll < s + d) return 'destroy';
        return 'keep';
      };

      var calculateInheritStar = function (currentStar) {
        var newStar = 12; // TMS default
        
        // GMS inheritance rules
        if (currentServer === 'gms') {
          if (currentStar >= 15 && currentStar <= 19) {
            newStar = 12;
          } else if (currentStar === 20) {
            newStar = 15;
          } else if (currentStar >= 21 && currentStar <= 22) {
            newStar = 17;
          } else if (currentStar >= 23 && currentStar <= 25) {
            newStar = 19;
          } else if (currentStar >= 26 && currentStar <= 30) {
            newStar = 20;
          } else {
            newStar = 12; // fallback for lower stars
          }
        }
        
        return newStar;
      };

      var doStrengthenStep = function () {
        var cost = getCostByLevelAndStage(state.currentLevel, state.currentStar);
        var chanceRow = getChanceRow(state.currentStar);
        if (cost == null || !chanceRow) {
          els.resultBox.textContent = '该阶段或等级没有花费/概率数据。';
          return;
        }

        if (state.currentMesos < cost) {
          els.resultBox.textContent = '资金不足，无法强化。';
          return;
        }

        // 扣费
        if (state.currentMesos !== Infinity) {
          state.currentMesos -= cost;
        }
        state.totalConsumed += cost;

        var outcome = pickOutcome(chanceRow);
        if (outcome === 'success') {
          state.currentStar += 1;
          if (state.currentStar > state.highestStar) state.highestStar = state.currentStar;
          els.resultBox.textContent = '成功！上星至 ' + state.currentStar + '★，花费 ' + formatNumber(cost);
          state.awaitingInherit = false;
          setStrengthenLabel('强化');
        } else if (outcome === 'destroy') {
          var inheritStar = calculateInheritStar(state.currentStar);
          els.resultBox.textContent = '破坏！装备损毁，请选择"继承"（将继承至 ' + inheritStar + '★）。本次花费 ' + formatNumber(cost);
          state.awaitingInherit = true;
          setStrengthenLabel('继承');
        } else {
          els.resultBox.textContent = '维持，星级不变。花费 ' + formatNumber(cost);
          state.awaitingInherit = false;
          setStrengthenLabel('强化');
        }

        render();
      };

      var doInherit = function () {
        var newStar = calculateInheritStar(state.currentStar);
        state.currentStar = newStar;
        state.inheritCount += 1;
        state.awaitingInherit = false;
        setStrengthenLabel('强化');
        els.resultBox.textContent = '已继承，星级置为 ' + newStar + '★。';
        render();
      };

      els.btnStrengthen.addEventListener('click', function () {
        if (state.awaitingInherit) {
          doInherit();
        } else {
          doStrengthenStep();
        }
      });

      els.btnReset.addEventListener('click', function () {
        resetToStart();
      });

      // 当起始输入变动时，刷新起始与当前文案（不自动重置，以"重置"按钮为准）
      ['change', 'input'].forEach(function (evt) {
        els.startMesos.addEventListener(evt, function () { syncFromInputsToStart(); render(); });
        els.equipLevel.addEventListener(evt, function () { syncFromInputsToStart(); render(); });
        els.startStar.addEventListener(evt, function () { syncFromInputsToStart(); render(); });
      });

      // 服务器选择变更事件
      els.serverRadios.forEach(function (radio) {
        radio.addEventListener('change', async function () {
          if (this.checked) {
            const selectedServer = this.value;
            const data = await loadServerData(selectedServer);
            if (data) {
              applyOptionsToData();
              renderChanceTable();
              renderCostTable();
              resetToStart(); // 自动重置模拟器
              els.resultBox.textContent = `已切换到 ${selectedServer.toUpperCase()} 服务器，模拟器已重置。`;
            }
          }
        });
      });

      // 优惠选项变更事件
      const discountCheckbox = document.getElementById('discountCheckbox');
      const guaranteedCheckbox = document.getElementById('guaranteedCheckbox');
      
      discountCheckbox.addEventListener('change', function () {
        options.discount = this.checked;
        applyOptionsToData();
        renderChanceTable();
        renderCostTable();
        resetToStart();
        els.resultBox.textContent = this.checked ? '已启用上星7折优惠，模拟器已重置。' : '已关闭上星7折优惠，模拟器已重置。';
      });

      guaranteedCheckbox.addEventListener('change', function () {
        options.guaranteed = this.checked;
        applyOptionsToData();
        renderChanceTable();
        renderCostTable();
        resetToStart();
        els.resultBox.textContent = this.checked ? '已启用5, 10, 15星必成，模拟器已重置。' : '已关闭5, 10, 15星必成，模拟器已重置。';
      });

      // 初始化：加载默认服务器数据
      await loadServerData('tms');
      applyOptionsToData();
      renderChanceTable();
      renderCostTable();
      resetToStart();
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>